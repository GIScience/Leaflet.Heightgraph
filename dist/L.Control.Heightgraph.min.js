"use strict";L.Control.Heightgraph=L.Control.extend({options:{position:"bottomright",width:800,height:125,margins:{top:20,right:50,bottom:25,left:50},mappings:void 0,expand:!0,translation:{},expandCallback:void 0,xTicks:void 0,yTicks:void 0,highlightStyle:void 0},_defaultTranslation:{distance:"Distance",elevation:"Elevation",segment_length:"Segment length",type:"Type",legend:"Legend"},_init_options:function(){this._margin=this.options.margins,this._width=this.options.width,this._height=this.options.height,this._mappings=this.options.mappings,this._svgWidth=this._width-this._margin.left-this._margin.right,this._svgHeight=this._height-this._margin.top-this._margin.bottom,this._selectedOption=0,this._highlightStyle=this.options.highlightStyle||{color:"red"}},onAdd:function(a){var b=this._container=L.DomUtil.create("div","heightgraph");L.DomEvent.disableClickPropagation(b);var c=this._button=L.DomUtil.create("div","heightgraph-toggle",b);L.DomUtil.create("a","heightgraph-toggle-icon",c),this._closeButton=L.DomUtil.create("a","heightgraph-close-icon",b);this._showState=!1,this._initToggle(),this._init_options();this._svg=d3.select(this._container).append("svg").attr("class","heightgraph-container").attr("width",this._svgWidth+this._margin.left+this._margin.right).attr("height",this._svgHeight+this._margin.top+this._margin.bottom).append("g").attr("transform","translate("+this._margin.left+","+this._margin.top+")");return b},onRemove:function(a){this._removeMarkedSegmentsOnMap(),this._container=null,this._svg=void 0},addData:function(a){void 0!==this._svg&&this._svg.selectAll("*").remove(),this._data=a,this._init_options(),this._prepareData(),this._computeStats(),this._appendScales(),this._appendGrid(),this._createChart(this._selectedOption),this._data.length>1&&this._createSelectionBox(),this.options.expand&&this._expand()},_initToggle:function(){L.Browser.touch?L.DomEvent.on(this._container,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._button,"click",this._expand,this),L.DomEvent.on(this._closeButton,"click",this._expand,this)},_dragHandler:function(){d3.event.preventDefault(),d3.event.stopPropagation(),this._gotDragged=!0,this._drawDragRectangle()},_drawDragRectangle:function(){if(this._dragStartCoords){var a=this._dragCurrentCoords=d3.mouse(this._background.node()),b=Math.min(this._dragStartCoords[0],a[0]),c=Math.max(this._dragStartCoords[0],a[0]);if(this._dragRectangle||this._dragRectangleG)this._dragRectangle.attr("width",c-b).attr("x",b);else{var d=d3.select(this._container).select("svg").select("g");this._dragRectangleG=d.append("g"),this._dragRectangle=this._dragRectangleG.append("rect").attr("width",c-b).attr("height",this._svgHeight).attr("x",b).attr("class","mouse-drag").style("fill","grey").style("opacity",.5).style("pointer-events","none")}}},_resetDrag:function(){this._dragRectangleG&&(this._dragRectangleG.remove(),this._dragRectangleG=null,this._dragRectangle=null)},_dragEndHandler:function(){if(!this._dragStartCoords||!this._gotDragged)return this._dragStartCoords=null,this._gotDragged=!1,void this._resetDrag();var a=this._findItemForX(this._dragStartCoords[0]),b=this._findItemForX(this._dragCurrentCoords[0]);this._fitSection(a,b),this._dragStartCoords=null,this._gotDragged=!1},_dragStartHandler:function(){d3.event.preventDefault(),d3.event.stopPropagation(),this._gotDragged=!1,this._dragStartCoords=d3.mouse(this._background.node())},_calculateFullExtent:function(a){if(!a||a.length<1)throw new Error("no data in parameters");var b=new L.latLngBounds(a[0].latlng,a[0].latlng);return a.forEach(function(a){b.contains(a.latlng)||b.extend(a.latlng)}),b},_fitSection:function(a,b){var c,d=Math.min(a,b),e=Math.max(a,b);c=d!==e?this._calculateFullExtent(this._areasFlattended.slice(d,e+1)):[this._areasFlattended[d].latlng,this._areasFlattended[e].latlng],this._map.fitBounds(c)},_expand:function(){this._showState?(d3.select(this._button).style("display","block"),d3.select(this._container).selectAll("svg").style("display","none"),d3.select(this._closeButton).style("display","none")):(d3.select(this._button).style("display","none"),d3.select(this._container).selectAll("svg").style("display","block"),d3.select(this._closeButton).style("display","block")),this._showState=!this._showState,"function"==typeof this.options.expandCallback&&this.options.expandCallback(this._showState)},_removeChart:function(){void 0!==this._svg&&(this._svg.selectAll("path.area").remove(),this._svg.selectAll("path.border-top").remove(),this._svg.selectAll(".legend").remove(),this._svg.selectAll(".lineSelection").remove(),this._svg.selectAll(".horizontalLine").remove(),this._svg.selectAll(".horizontalLineText").remove())},_randomNumber:function(a){return Math.round(Math.random()*(a-0))},_d3ColorCategorical:[{name:"schemeAccent"},{name:"schemeDark2"},{name:"schemeSet2"},{name:"schemeSet1"},{name:"schemeCategory10"},{name:"schemeSet3"},{name:"schemePaired"},{name:"schemeCategory20"},{name:"schemeCategory20b"},{name:"schemeCategory20c"}],_prepareData:function(){this._profile={},this._profile.coordinates=[],this._profile.elevations=[],this._profile.cumDistances=[],this._profile.cumDistances.push(0),this._profile.blocks=[];var a,b=this._data,c=[];if(void 0===this._mappings){var d=this._randomNumber(c.length);a=d3.scaleOrdinal(d3[this._d3ColorCategorical[d].name])}for(var e=0;e<b.length;e++){var f=0;this._profile.blocks[e]={},this._profile.blocks[e].info={id:e,text:b[e].properties.summary},this._profile.blocks[e].distances=[],this._profile.blocks[e].attributes=[],this._profile.blocks[e].geometries=[],this._profile.blocks[e].legend={};var g=void 0,h=0,i={};for(g=0;g<b[e].features.length;g++){var j=void 0,k=void 0,l=void 0,m=void 0,n=[],o=b[e].features[g].geometry.coordinates.length,p=b[e].features[g].properties.attributeType,q=void 0,r=void 0;void 0===this._mappings?p in i?(q=p,r=i[p]):(q=p,r=a(g),i[p]=r):(q=this._mappings[b[e].properties.summary][p].text,r=this._mappings[b[e].properties.summary][p].color);var s={type:p,text:q,color:r};this._profile.blocks[e].attributes.push(s),p in this._profile.blocks[e].legend||(this._profile.blocks[e].legend[p]=s);for(var t=0;t<o;t++){k=new L.LatLng(b[e].features[g].geometry.coordinates[t][1],b[e].features[g].geometry.coordinates[t][0]),j=b[e].features[g].geometry.coordinates[t][2],t<o-1?(l=new L.LatLng(b[e].features[g].geometry.coordinates[t+1][1],b[e].features[g].geometry.coordinates[t+1][0]),m=k.distanceTo(l)/1e3,f+=m,0===e&&(this._profile.elevations.push(j),this._profile.coordinates.push(k),this._profile.cumDistances.push(f)),h+=1):t===o-1&&g===b[e].features.length-1&&(0===e&&(this._profile.elevations.push(j),this._profile.coordinates.push(l)),h+=1);var u=void 0;u=t===o-1&&g<b[e].features.length-1?this._profile.cumDistances[h]:this._profile.cumDistances[h-1],n.push({altitude:j,position:u,x:k.lng,y:k.lat,latlng:k,type:q,areaIdx:g})}this._profile.blocks[e].distances.push(f),this._profile.blocks[e].geometries.push(n)}e===b.length-1&&(this._profile.totalDistance=f)}},_computeStats:function(){var a=this._profile.maxElevation=d3.max(this._profile.elevations),b=this._profile.minElevation=d3.min(this._profile.elevations),c=this._profile.elevationQuantile=d3.quantile(this._profile.elevations,.75);this._profile.yElevationMin=c<b+b/10?b-a/5<0?0:b-a/5:b-a/10,this._profile.yElevationMax=c>a-a/10?a+a/3:a},_showMarker:function(a,b,c){var d=this._map.latLngToLayerPoint(a),e=d.y-75;if(!this._mouseHeightFocus){var f=d3.select(".leaflet-overlay-pane svg").append("g");this._mouseHeightFocus=f.append("svg:line").attr("class","height-focus line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0"),this._mouseHeightFocusLabel=f.append("g").attr("class","height-focus label"),this._mouseHeightFocusLabelRect=this._mouseHeightFocusLabel.append("rect").attr("class","bBox"),this._mouseHeightFocusLabelTextElev=this._mouseHeightFocusLabel.append("text").attr("class","tspan"),this._mouseHeightFocusLabelTextType=this._mouseHeightFocusLabel.append("text").attr("class","tspan");(this._pointG=f.append("g").attr("class","height-focus circle")).append("svg:circle").attr("r",5).attr("cx",0).attr("cy",0).attr("class","height-focus circle-lower")}this._mouseHeightFocusLabel.style("display","block"),this._mouseHeightFocus.attr("x1",d.x).attr("x2",d.x).attr("y1",d.y).attr("y2",e).style("display","block"),this._pointG.attr("transform","translate("+d.x+","+d.y+")").style("display","block"),this._mouseHeightFocusLabelRect.attr("x",d.x+3).attr("y",e).attr("class","bBox"),this._mouseHeightFocusLabelTextElev.attr("x",d.x+5).attr("y",e+12).text(b+" m").attr("class","tspan mouse-height-box-text"),this._mouseHeightFocusLabelTextType.attr("x",d.x+5).attr("y",e+24).text(c).attr("class","tspan mouse-height-box-text");var g=this._dynamicBoxSize("text.tspan")[1],h=""===c?18:30;d3.selectAll(".bBox").attr("width",g+10).attr("height",h)},_createChart:function(a){var b=this._profile.blocks[a].geometries;this._areasFlattended=[].concat.apply([],b);for(var c=0;c<b.length;c++)this._appendAreas(b[c],a,c);this._createFocus(),this._appendBackground(),this._createBorderTopLine(),this._createLegend(),this._createHorizontalLine()},_createFocus:function(){var a=this._profile.yElevationMin,b=15;this._focus&&(this._focus.remove(),this._focusLineGroup.remove()),this._focus=this._svg.append("g").attr("class","focusbox"),this._focusRect=this._focus.append("rect").attr("x",3).attr("y",-this._y(a)).attr("display","none"),this._focusDistance=this._focus.append("text").attr("x",7).attr("y",-this._y(a)+b).attr("id","distance").text(this._getTranslation("distance")+":"),this._focusHeight=this._focus.append("text").attr("x",7).attr("y",-this._y(a)+2*b).attr("id","height").text(this._getTranslation("elevation")+":"),this._focusBlockDistance=this._focus.append("text").attr("x",7).attr("y",-this._y(a)+3*b).attr("id","blockdistance").text(this._getTranslation("segment_length")+":"),this._focusType=this._focus.append("text").attr("x",7).attr("y",-this._y(a)+4*b).attr("id","type").text(this._getTranslation("type")+":"),this._areaTspan=this._focusBlockDistance.append("tspan").attr("class","tspan"),this._typeTspan=this._focusType.append("tspan").attr("class","tspan");var c=this._dynamicBoxSize(".focusbox text")[0];d3.selectAll(".focusbox rect").attr("height",c*b+b/2).attr("display","block"),this._focusLineGroup=this._svg.append("g").attr("class","focusLine"),this._focusLine=this._focusLineGroup.append("line").attr("y1",0).attr("y2",this._y(this._profile.yElevationMin)),this._distTspan=this._focusDistance.append("tspan").attr("class","tspan"),this._altTspan=this._focusHeight.append("tspan").attr("class","tspan")},_createHorizontalLine:function(){var a=this;this._horizontalLine=this._svg.append("line").attr("class","horizontalLine").attr("x1",0).attr("x2",this._width-this._margin.left-this._margin.right).attr("y1",this._y(this._profile.yElevationMin)).attr("y2",this._y(this._profile.yElevationMin)).style("stroke","black"),this._elevationValueText=this._svg.append("text").attr("class","horizontalLineText").attr("x",this._width-this._margin.left-this._margin.right-20).attr("y",this._y(this._profile.yElevationMin)-10).attr("fill","black");var b=[{x:this._width-this._margin.left-this._margin.right+7,y:this._y(this._profile.yElevationMin),color:"black",type:d3.symbolTriangle,angle:-90,size:100}],c=function(a){d3.select(this).raise().classed("active",!0),d3.select(".horizontalLine").raise().classed("active",!0)},d=function(b){var c=a._svgHeight,d=d3.mouse(a._container)[1]-10;d3.select(this).attr("transform",function(a){return"translate("+a.x+","+(d<0?0:d>c?c:d)+") rotate("+a.angle+")"}),d3.select(".horizontalLine").attr("y1",d<0?0:d>c?c:d).attr("y2",d<0?0:d>c?c:d),a._highlightedCoords=d>=c?[]:a._findCoordsForY(d),d3.select(".horizontalLineText").attr("y",d<=10?0:d>c?c-10:d-10).text(d3.format(".0f")(a._y.invert(d<0?0:d>c?c:d))+" m"),a._removeMarkedSegmentsOnMap(),a._markSegmentsOnMap(a._highlightedCoords)},e=function(b){d3.select(this).classed("active",!1),d3.select(".horizontalLine").classed("active",!1),a._removeMarkedSegmentsOnMap(),a._markSegmentsOnMap(a._highlightedCoords)};this._svg.selectAll(".horizontal-symbol").data(b).enter().append("path").attr("class","lineSelection").attr("d",d3.symbol().type(function(a){return a.type}).size(function(a){return a.size})).attr("transform",function(a){return"translate("+a.x+","+a.y+") rotate("+a.angle+")"}).attr("id",function(a){return a.id}).style("fill",function(a){return a.color}).call(d3.drag().on("start",c).on("drag",d).on("end",e))},_markSegmentsOnMap:function(a){if(a)if(a.length>1){this._markedSegments=L.featureGroup();var b=!0,c=!1,d=void 0;try{for(var e,f=a[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;L.polyline(g,this._highlightStyle).addTo(this._markedSegments)}}catch(h){c=!0,d=h}finally{try{b||null==f.return||f.return()}finally{if(c)throw d}}this._markedSegments.addTo(this._map).bringToFront()}else this._markedSegments=L.polyline(a,this._highlightStyle).addTo(this._map)},_removeMarkedSegmentsOnMap:function(){void 0!==this._markedSegments&&this._map.removeLayer(this._markedSegments)},_appendScales:function(){var a=Boolean(this._profile.totalDistance<=10),b=this._profile.yElevationMin,c=this._profile.yElevationMax,d=(this._margin,this._width-this._margin.left-this._margin.right),e=this._height-this._margin.top-this._margin.bottom;this._x=d3.scaleLinear().range([0,d]),this._y=d3.scaleLinear().range([e,0]),this._x.domain([0,this._profile.totalDistance]),this._y.domain([b,c]),this._xAxis=!0===a?d3.axisBottom().scale(this._x).tickFormat(function(a){return d3.format(".2f")(a)+" km"}):d3.axisBottom().scale(this._x).tickFormat(function(a){return d3.format(".0f")(a)+" km"}),this.options.xTicks&&this._xAxis.ticks(this.options.xTicks),this._yAxis=d3.axisLeft().scale(this._y).tickFormat(function(a){return a+" m"}),this.options.yTicks&&this._yAxis.ticks(this.options.yTicks),this._yEndAxis=d3.axisRight().scale(this._yEnd).ticks(0)},_appendBackground:function(){var a=this._background=d3.select(this._container).select("svg").select("g").append("rect").attr("width",this._svgWidth).attr("height",this._svgHeight).style("fill","none").style("stroke","none").style("pointer-events","all").on("mousemove.focusbox",this._mousemoveHandler.bind(this)).on("mouseout.focusbox",this._mouseoutHandler.bind(this));L.Browser.android?(a.on("touchstart.drag",this._dragHandler.bind(this)).on("touchstart.drag",this._dragStartHandler.bind(this)).on("touchstart.focusbox",this._mousemoveHandler.bind(this)),L.DomEvent.on(this._container,"touchend",this._dragEndHandler,this)):(a.on("mousemove.focusbox",this._mousemoveHandler.bind(this)).on("mouseout.focusbox",this._mouseoutHandler.bind(this)).on("mousedown.drag",this._dragStartHandler.bind(this)).on("mousemove.drag",this._dragHandler.bind(this)),L.DomEvent.on(this._container,"mouseup",this._dragEndHandler,this))},_appendGrid:function(){this._svg.append("g").attr("class","grid").attr("transform","translate(0,"+this._svgHeight+")").call(this._make_x_axis().tickSize(-this._svgHeight,0,0).tickFormat("")),this._svg.append("g").attr("class","grid").call(this._make_y_axis().tickSize(-this._svgWidth,0,0).ticks(5).tickFormat("")),this._svg.append("g").attr("transform","translate(0,"+this._svgHeight+")").attr("class","x axis").call(this._xAxis),this._svg.append("g").attr("transform","translate(-2,0)").attr("class","y axis").call(this._yAxis)},_appendAreas:function(a,b,c){var d=this._profile.blocks[b].attributes[c].color,e=this;this._area=d3.area().x(function(a){var b=e._x(a.position);return a.xDiagonalCoordinate=b,b}).y0(this._svgHeight).y1(function(a){return e._y(a.altitude)}).curve(d3.curveLinear);this._areapath=this._svg.append("path").attr("class","area"),this._areapath.datum(a).attr("d",this._area).attr("stroke",d).style("fill",d).style("pointer-events","none")},_make_x_axis:function(){return d3.axisBottom().scale(this._x)},_make_y_axis:function(){return d3.axisLeft().scale(this._y)},_createSelectionBox:function(){var a=this,b=d3.select(this._container).select("svg"),c=(this._margin,this._width-this._margin.left-this._margin.right),d=this._height-this._margin.top-this._margin.bottom,e=[{x:c-50,y:d+48,color:"#000",type:d3.symbolTriangle,id:"leftArrowSelection",angle:-360},{x:c-35,y:d+45,color:"#000",type:d3.symbolTriangle,id:"rightArrowSelection",angle:180}],f=(b.selectAll(".select-symbol").data(e).enter().append("path").attr("class","select-symbol").attr("d",d3.symbol().type(function(a){return a.type})).attr("transform",function(a){return"translate("+a.x+","+a.y+") rotate("+a.angle+")"}).attr("id",function(a){return a.id}).style("fill",function(a){return a.color}).on("click",function(a){"rightArrowSelection"===a.id&&h(),"leftArrowSelection"===a.id&&i()}),function(e){var f=a._profile.blocks[e].info,g=[{selection:f.text}];a._selectionText&&a._selectionText.remove(),a._selectionText=b.selectAll("selection_text").data(g).enter().append("text").attr("x",c-20).attr("y",d+50).text(function(a){return a.selection}).attr("class","select-info").attr("id","selectionText")}),g=(this._profile.blocks.length,this._selectedOption);f(g);var h=function(){var b=a._selectedOption+=1;b===a._profile.blocks.length&&(a._selectedOption=b=0),f(b),a._removeChart(),a._removeMarkedSegmentsOnMap(),a._createChart(b)},i=function(){var b=a._selectedOption-=1;-1===b&&(a._selectedOption=b=a._profile.blocks.length-1),f(b),a._removeChart(),a._removeMarkedSegmentsOnMap(),a._createChart(b)}},_createLegend:function(){var a=this,b=[];for(var c in this._profile.blocks[this._selectedOption].legend)b.push(this._profile.blocks[this._selectedOption].legend[c]);var d=(this._margin,this._width,this._margin.left,this._margin.right,this._height-this._margin.top-this._margin.bottom),e=[{text:this._getTranslation("legend")}],f=7,g=7,h=this._svg.selectAll(".hlegend-hover").data(b).enter().append("g").attr("class","legend").style("display","none").attr("transform",function(a,b){var c=f+g;return"translate("+(f-15)+","+(b*c-2*c)+")"});h.append("rect").attr("class","legend-rect").attr("x",15).attr("y",36).attr("width",6).style("stroke","black").attr("height",6).style("fill",function(a,b){return a.color}),h.append("text").attr("class","legend-text").attr("x",30).attr("y",42).text(function(b,c){var e=b.text;return a._boxBoundY=(d-2*d/3+7)*c,e}),this._svg.selectAll(".legend-hover").data(e).enter().append("g").attr("class","legend-hover").append("text").attr("class","legend-menu").attr("class","no-select").attr("x",15).attr("y",d+40).text(function(a,b){return a.text}).on("mouseover",function(){d3.select(".legend-box").style("display","block"),d3.selectAll(".legend").style("display","block")}).on("mouseleave",function(){d3.select(".legend-box").style("display","none"),d3.selectAll(".legend").style("display","none")})},_dynamicBoxSize:function(a){for(var b=d3.selectAll(a).nodes().length,c=[],d=0;d<b;d++)c.push(d3.selectAll(a).nodes()[d].getBoundingClientRect().width);return[b,d3.max(c)]},_createBorderTopLine:function(){var a=this,b=this._areasFlattended,c=d3.line().x(function(b){return(0,a._x)(b.position)}).y(function(b){return(0,a._y)(b.altitude)}).curve(d3.curveBasis);this._svg.append("svg:path").attr("d",c(b)).attr("class","border-top")},_mouseoutHandler:function(){for(var a=0,b=["_focusLine","_focus","_pointG","_mouseHeightFocus","_mouseHeightFocusLabel"];a<b.length;a++){var c=b[a];this[c]&&this[c].style("display","none")}},_mousemoveHandler:function(a,b,c){var d,e=d3.mouse(this._svg.node()),f=this._areasFlattended[this._findItemForX(e[0])],g=f.altitude,h=f.position,i=f.latlng,j=f.areaIdx,k=f.type,l=this._dynamicBoxSize(".focusbox text")[1]+10;d=0===j?this._profile.blocks[this._selectedOption].distances[j]:this._profile.blocks[this._selectedOption].distances[j]-this._profile.blocks[this._selectedOption].distances[j-1],this._showMarker(i,g,k),this._distTspan.text(" "+h.toFixed(1)+" km"),this._altTspan.text(" "+g+" m"),this._areaTspan.text(" "+d.toFixed(1)+" km"),this._typeTspan.text(" "+k),this._focusRect.attr("width",l),this._focusLine.style("display","block").attr("x1",this._x(h)).attr("x2",this._x(h));var m=this._x(h)-(l+5),n=this._width-this._margin.left-this._margin.right;this._x(h)+l<n&&this._focus.style("display","initial").attr("transform","translate("+this._x(h)+","+this._y(this._profile.yElevationMin)+")"),this._x(h)+l>n&&this._focus.style("display","initial").attr("transform","translate("+m+","+this._y(this._profile.yElevationMin)+")")},_findItemForX:function(a){var b=d3.bisector(function(a){return a.position}).left,c=this._x.invert(a);return b(this._areasFlattended,c)},_findCoordsForY:function(a){var b=function(a,b){for(var c=[],d=0;d<a.length;d++)a[d].altitude>=b&&c.push(d);for(var e=[],f=0,g=0;g<c.length-1;g++)c[g+1]!==c[g]+1&&(e.push(c.slice(f,g+1)),f=g+1);e.push(c.slice(f,c.length));for(var h=0;h<e.length;h++)for(var i=0;i<e[h].length;i++)e[h][i]=a[e[h][i]].latlng;return e},c=this._y.invert(a);return b(this._areasFlattended,c)},_getTranslation:function(a){return this.options.translation[a]?this.options.translation[a]:this._defaultTranslation[a]?this._defaultTranslation[a]:(console.error("Unexpected error when looking up the translation for "+a),"No translation found")}}),L.control.heightgraph=function(a){return new L.Control.Heightgraph(a)};